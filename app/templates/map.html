{% extends "demography_base.html" %}

{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}

{% block title %}Demography{% endblock %}

{% block content %}


<div id ="loading"><p><span class="glyphicon glyphicon-map-marker"></span></p></div>
<div id="map"></div>

<div class="info panel panel-default" id="info">
  <div class="panel-heading">
    <h3 class="panel-title">Plant View</h3>
  </div>
</div>

<div class="common panel panel-default" id="common">
  <div class="panel-heading">
    <h3 class="panel-title">Commons Data</h3>
  </div>
</div>


{% endblock %}

{% block scripts %}
{{ super() }}
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
<link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
<link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' 
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script>
$( document ).ready(function() {

  $('#loading').each(function(){
        //get img dimensions
        var h = $(this).height();
        var w = $(this).width();

        //get div dimensions
        var div_h =$(window).height();
        var div_w =$(window).width();


        //set img position
        $(this).css({
          'margin-top' : Math.round((div_h - h) / 2) + 'px',
          'margin-left' : Math.round((div_w - w) / 2) + 'px'
        })
    });


  $('.glyphicon-map-marker').each(function(){
        //get img dimensions
        var h = $(this).height();
        var w = $(this).width();

        //get div dimensions
        var div_h =$('#loading').height();
        var div_w =$('#loading').width();


        //set img position
        $(this).css({
          'margin-top' : Math.round(Math.abs((div_h + h) * 2)) + 'px',
        })

        console.log(Math.abs((div_h + h)) * 2)
    });



  L.mapbox.accessToken = 'pk.eyJ1IjoiZnJhbmNlc2Nhc2FyZ2VudCIsImEiOiJvZmFuUzM0In0.-gsScOsPRxKs9E8qNy3qwg'

  var baseLayer = L.mapbox.tileLayer('francescasargent.ja3p4m1n', {
    maxZoom: 5
  });

  var markers = L.markerClusterGroup({
                      polygonOptions: {
                        fillColor: '#9b59b6',
                        color: '#9b59b6',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.5
                      }
                    });

  $.getJSON("{{ url_for(".geojson") }}", function(data) {
    var geojson = L.geoJson(data, {
      onEachFeature: function (feature, layer) {

        layer.setIcon(L.mapbox.marker.icon({'marker-color': '#27ae60'}));

        layer.bindPopup('<em>'+feature.properties.name+'</em><br/>'+feature.properties.population+', '+feature.properties.country+'<p><a><span class="float focus glyphicon glyphicon-search" aria-hidden="true"></a></span></p>');
  


      }
    });
    markers.addLayer(geojson);

    var map = L.map('map', {maxZoom: 9, minZoom: 3}).fitBounds(markers.getBounds());
    baseLayer.addTo(map).on('load', addMarkers);
    
    function addMarkers() {
      console.log("loaded");
      markers.addTo(map);
      $('#map').animate({
        'opacity' : '1',
        'background' : '#c0c0c0'
      }, 3000);
      $('#loading').fadeOut()
    }

    markers.on('click',function(e, layer, map) {
      var feature = e.layer.feature;
      console.log(feature.properties.name);
      console.log(feature.properties.species.localimageurl)

      function setDefaultContent(statusstudy, statuselsewhere) {
        var content = '<div class="panel-heading"><strong>#'+feature.properties.matrixnumber+' </strong><em> '+feature.properties.name+'</em></div><ul class="list-group"><li class="list-group-item '+statusstudy+' '+statuselsewhere+'-else "><em>'+feature.properties.name+'</em> is '+ statusstudy +' in '+feature.properties.continent+', and '+ statuselsewhere +' elsewhere</li></ul>';
        $('#info').html(content);
      }

      var statusstudy = feature.properties.statusstudy;
      var statuselsewhere = feature.properties.statuselsewhere;
      setDefaultContent(statusstudy, statuselsewhere);

      if ((feature.properties.species.commonname).length > 0) {
          function squareImage(classname) {
        var width = $('.' + classname).width()
        var height = $('.' + classname).height()

          $('.species').css({
            "background": "url({{ url_for('static', filename='images/eol/thumbs/big/big') }}"+feature.properties.species.localimageurl+".jpg) 50% 50% no-repeat",
            "background-position" : "center",
            "border-radius" : "50%",
            "border" : "8px solid #FFAB06",
            "margin" : "50px"
          });

        $('.species').animate({
          "opacity" : "1"
        }, 1000)
      }

      function setContent() {
      var img = feature.properties.species.localimageurl
      var commoncontent = '<div class="commoncontent sp"><div class="panel-heading sp"><h3>'+feature.properties.species.commonname+'</h3></div><ul class="list-group"><li class="list-group-item sp"><em>'+feature.properties.name+'</em></li><li class="list-group-item thumbnail sp"><div class="species"><img class="speciesimage" src="{{ url_for("static", filename="images/eol/thumbs/big/big") }}' + feature.properties.species.localimageurl + '.jpg"></div></li><li class="list-group-item sp"><span class= "glyphicon glyphicon-link"></span>&nbsp;<a href="'+feature.properties.species.originalpageurl+'" target="_blank">'+feature.properties.species.originalpageurl+'</a></li></ul>'
      $('#common').html(commoncontent);
      
    }
    
     
    setContent();

     $('.focus').click(function(e, map){
        $('.commoncontent').fadeIn(1000, function() {
          squareImage('speciesimage');
        });        
      });

     

     console.log(feature.properties.species.originalpageurl)

      } else {
        console.log("No data yet")
      }

      
  });

  map.on('move', empty);

  empty();

  function empty() {
    $('#info').html('');
    $('#common').html('');
  }
    
});

});

</script>
{% endblock %}